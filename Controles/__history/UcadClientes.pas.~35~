unit UcadClientes;

interface

uses
  System.SysUtils, System.Classes, FireDAC.Stan.Intf, FireDAC.Stan.Option,
  FireDAC.Stan.Error, FireDAC.UI.Intf, FireDAC.Phys.Intf, FireDAC.Stan.Def,
  FireDAC.Stan.Pool, FireDAC.Stan.Async, FireDAC.Phys, FireDAC.Phys.FB,
  FireDAC.Phys.FBDef, FireDAC.VCLUI.Wait, FireDAC.Comp.Client, Data.DB,
  FireDAC.Stan.Param, FireDAC.DatS, FireDAC.DApt.Intf, FireDAC.DApt,
  FireDAC.Comp.DataSet, FireDAC.Phys.IBBase, Dialogs, Datasnap.DBClient,
  Datasnap.Provider,Data.Win.ADODB,Uconexao, vcl.Controls, Vcl.DBCtrls,
  UViaCEP, Vcl.Forms;

type
  TEndereco_Cliente = record
    endereco: string;
    complemento: string;
    bairro: string;
    cidade: string;
    estado: string;
    UF: string;
  end;
  TcadClientes = class
    private
      Function ExecutarSQL(SQl: string): Boolean;
      function ObterIDCidade(NomeCidade: string): String;
      function ObterIdEstado(NomeEstado: String): String;
      procedure VerificaEstadoECidade;
      procedure IncluirNovoEstado;
      procedure IncluirNovaCidade;
    public
      FqueryClientes : TFDQuery;
      FDataSourceCliente : TDataSource;
      FqueryAux : TFDQuery;
      FCDS_Aux: TClientDataSet;
      FDTS_Aux : TDataSource;
      FqueryCidades : TFDQuery;
      FDtsCidades : TDataSource;
      FqueryEstados : TFDQuery;
      FDtsEstados : TDataSource;
      FOpcaoFiltro: Integer;
      FDataNascIni: TDate;
      FDataNascFin: TDate;
      FIdCidade: integer;
      FIdEstado: Integer;
      Endereco_Cliente: TEndereco_Cliente;
      constructor Create;
      procedure CarregarDadosClientes;
      procedure CarregarCidades;
      procedure CarregarEstados;
      procedure RetornarDadosDoCliente(IdCliente:integer);
      procedure Persistencia(RegistroNovo: Boolean);
      procedure Excluir;
      function BuscarCEP(CEP:String): Boolean;
      function ObterNomeCidade(Id: String): String;
      procedure AplicarFiltros;
  end;

implementation


{ TcadClientes }

procedure TcadClientes.AplicarFiltros;
begin
  case FOpcaoFiltro of
    0:
    begin
      FqueryClientes.Filtered := False;
      FqueryClientes.Filter := '';
    end;
    1:
    begin
      FqueryClientes.Filtered := False;
      FqueryClientes.Filter := ' DATANASCIMENTO BETWEEN '+ QuotedStr(FormatDateTime('yyyy-mm-dd', FDataNascIni ))+' AND '+
                                 QuotedStr(FormatDateTime('yyyy-mm-dd', FDataNascFin));
      FqueryClientes.Filtered := True;
    end;
    2:
    begin
      FqueryClientes.Filtered := False;
      FqueryClientes.Filter := ' CI.ID = '+ IntToStr(FIdCidade);
      FqueryClientes.Filtered := True;
    end;
    3:
    begin
      FqueryClientes.Filtered := False;
      FqueryClientes.Filter := ' ES.ID = '+ IntToStr(FIdEstado);
      FqueryClientes.Filtered := True;
    end;
  end;

end;

function TcadClientes.BuscarCEP(CEP:String): Boolean;
var
  ViaCEP: TViaCEP;
  Endereco: TEndereco;
begin
  ViaCEP := TViaCEP.Create;
  try
    Screen.Cursor := crHourGlass;
    try
      Endereco := ViaCEP.BuscarCEP(CEP);

      if not Endereco.Erro then
      begin
        //edt_CEP.Text := TValidacoes.FormatarCEP(Endereco.CEP);
        Endereco_Cliente.endereco := Endereco.Logradouro;
        Endereco_Cliente.bairro := Endereco.Bairro;
        Endereco_Cliente.cidade := Endereco.Localidade;
        Endereco_Cliente.estado := Endereco.Estado;
        Endereco_Cliente.UF := Endereco.UF;
        MessageDlg('Endereço encontrado com sucesso!',TMsgDlgType.mtConfirmation,[TMsgDlgBtn.mbOK],0);
        Result := True;
      end
      else
      begin
        MessageDlg('Erro ao buscar CEP: ' + Endereco.MensagemErro,TMsgDlgType.mtError,[TMsgDlgBtn.mbOK],0);
        Result:= False;
      end;
    finally
      Screen.Cursor := crDefault;
    end;
  finally
    ViaCEP.Free;
  end;
end;

procedure TcadClientes.CarregarCidades;
begin
  FqueryCidades.close;
  FqueryCidades.sql.Clear;
  FqueryCidades.sql.Add('SELECT ID, NOME FROM CIDADE ORDER BY NOME');
  FqueryCidades.Open;
end;

procedure TcadClientes.CarregarDadosClientes;
begin
  FqueryClientes.Close;
  FqueryClientes.sql.Clear;
  FqueryClientes.sql.Add('SELECT                       ');
  FqueryClientes.sql.Add('     CL.id,                  ');
  FqueryClientes.sql.Add('     CL.NOME AS NOME_CLIENTE,');
  FqueryClientes.sql.Add('     CL.CEP,                 ');
  FqueryClientes.sql.Add('     CL.CPF_CNPJ,            ');
  FqueryClientes.sql.Add('     CL.ENDERECO,            ');
  FqueryClientes.sql.Add('     CL.NUMERO,              ');
  FqueryClientes.sql.Add('     CL.COMPLEMENTO,         ');
  FqueryClientes.sql.Add('     CL.BAIRRO,              ');
  FqueryClientes.sql.Add('     CL.CIDADE,              ');
  FqueryClientes.sql.Add('     CI.NOME AS NOME_CIDADE, ');
  FqueryClientes.sql.Add('     ES.NOME AS NOME_ESTADO, ');
  FqueryClientes.sql.Add('     CL.DATANASCIMENTO,      ');
  FqueryClientes.sql.Add('     ''  '' AS UF            ');
  FqueryClientes.sql.Add(' FROM                        ');               ///Alterar para filtro para não consumir o banco, usar dados da memória!
  FqueryClientes.sql.Add('    CLIENTE CL               ');
  FqueryClientes.sql.Add('    JOIN CIDADE CI ON        ');
  FqueryClientes.sql.Add('     CL.CIDADE = CI.ID       ');
  FqueryClientes.sql.Add('    JOIN ESTADO ES ON        ');
  FqueryClientes.sql.Add('     ES.ID = CI.ESTADOID     ');
  FqueryClientes.sql.Add(' ORDER BY CL.NOME            ');

  FqueryClientes.Open;
end;

procedure TcadClientes.CarregarEstados;
begin
  FqueryEstados.Close;
  FqueryEstados.sql.Clear;
  FqueryEstados.SQL.Add('SELECT ID, NOME FROM ESTADO');
  FqueryEstados.Open;
end;

constructor TcadClientes.Create;
var
  Conexao: Tconecxao;
begin
   Conexao := Tconecxao.Create;
   try
     FqueryClientes := TFDQuery.Create(nil);
     FDataSourceCliente := TDataSource.Create(nil);
     FCDS_Aux := TClientDataSet.Create(nil);
     FDTS_Aux := TDataSource.Create(nil);
     FqueryAux := TFDQuery.Create(nil);
     FqueryAux.Connection := Conexao.Connection;
     Conexao.CarregarParemtrosDeConexao;
     FqueryClientes.Connection := Conexao.Connection;
     FDataSourceCliente.DataSet := FqueryClientes;
     FqueryCidades := TFDQuery.Create(nil);
     FDtsCidades := TDataSource.Create(nil);
     FqueryCidades.Connection := Conexao.Connection;
     FDtsCidades.DataSet := FqueryCidades;
     FqueryEstados := TFDQuery.Create(nil);
     FDtsEstados := TDataSource.Create(nil);
     FqueryEstados.Connection := Conexao.Connection;
     FDtsEstados.DataSet := FqueryEstados;
   finally
     FreeAndNil(Conexao);
   end;

end;

procedure TcadClientes.Excluir;
var
  SQL: string;
begin
  SQL := 'DELETE FROM CLIENTE WHERE ID = '+ IntToStr(FCDS_Aux.FieldByName('ID').AsInteger);

  if ExecutarSQL(SQL) then
  begin
     MessageDlg('Cliente excluído com sucesso!',TMsgDlgType.mtConfirmation,[TMsgDlgBtn.mbOK],0);
  end;

end;


function TcadClientes.ExecutarSQL(Sql: String): Boolean;
begin
  Result := False;
  FqueryClientes.Connection.StartTransaction;
  try
    FqueryClientes.SQL.Text := SQL;
    FqueryClientes.ExecSQL;
    FqueryClientes.Connection.Commit;
    Result := True;
  except
    on E: Exception do
    begin
      FqueryClientes.Connection.Rollback;
      MessageDlg('Erro ao executar SQL: ' + E.Message,TMsgDlgType.mtError ,[TMsgDlgBtn.mbOK],0);
      Result := False;
    end;
  end;
end;

procedure TcadClientes.IncluirNovaCidade;
var
 SQL:String;
begin
  SQL := 'INSERT INTO CIDADE (NOME, ESTADOID) VALUES (' +
           QuotedStr(FCDS_Aux.FieldByName('NOME_CIDADE').asstring) + ', ' +
           ObterIdEstado(FCDS_Aux.FieldByName('NOME_ESTADO').asstring) + ')' ;

  ExecutarSQL(SQL);
end;

procedure TcadClientes.IncluirNovoEstado;
var
 SQL:String;
begin
  SQL := 'INSERT INTO ESTADO (NOME, UF) VALUES (' +
         QuotedStr(FCDS_Aux.FieldByName('NOME_ESTADO').asstring) + ', ' +
         QuotedStr(FCDS_Aux.FieldByName('UF').asstring) + ')' ;

  ExecutarSQL(SQL);
end;


procedure TcadClientes.VerificaEstadoECidade;
begin
  FqueryAux.close;
  FqueryAux.SQL.Clear;
  FqueryAux.sql.Add('SELECT                                                                           ');
  FqueryAux.sql.Add('X.ESTADO,                                                                        ');
  FqueryAux.sql.Add('X.CIDADE                                                                         ');
  FqueryAux.sql.Add(' FROM (                                                                          ');
  FqueryAux.sql.Add('    SELECT                                                                       ');
  FqueryAux.sql.Add('        ES.NOME AS ESTADO,                                                       ');
  FqueryAux.sql.Add('        NULL AS CIDADE                                                           ');
  FqueryAux.sql.Add('     FROM ESTADO ES                                                              ');
  FqueryAux.sql.Add('     WHERE ES.UF = '+QuotedStr(FCDS_Aux.FieldByName('UF').asstring) +'           ');
  FqueryAux.sql.Add('UNION ALL                                                                        ');
  FqueryAux.sql.Add('    SELECT                                                                       ');
  FqueryAux.sql.Add('        NULL AS ESTADO,                                                          ');
  FqueryAux.sql.Add('        CI.NOME AS CIDADE                                                        ');
  FqueryAux.sql.Add('     FROM CIDADE CI                                                              ');
  FqueryAux.sql.Add('     WHERE CI.NOME = '+QuotedStr(FCDS_Aux.FieldByName('NOME_CIDADE').asstring)+' ');
  FqueryAux.sql.Add(') X                                                                              ');
  FqueryAux.Open;

  if FqueryAux.FieldByName('ESTADO').IsNull then
      IncluirNovoEstado;
  if FqueryAux.FieldByName('CIDADE').IsNull then
      IncluirNovaCidade;

end;

function TcadClientes.ObterIDCidade(NomeCidade: string): string;
begin
  FqueryAux.sql.Clear;
  FqueryAux.Close;
  FqueryAux.SQL.Add('SELECT ID FROM CIDADE WHERE NOME ='+ QuotedStr(NomeCidade));
  FqueryAux.Open;

  if not FqueryAux.IsEmpty then
    Result := FqueryAux.FieldByName('ID').AsString

end;

function TcadClientes.ObterIdEstado(NomeEstado: String): String;
begin
  FqueryAux.sql.Clear;
  FqueryAux.Close;
  FqueryAux.SQL.Add('SELECT ID FROM ESTADO WHERE NOME ='+ QuotedStr(NomeEstado));
  FqueryAux.Open;

  if not FqueryAux.IsEmpty then
    Result := FqueryAux.FieldByName('ID').AsString
end;

function TcadClientes.ObterNomeCidade(Id: String): String;
begin
  FqueryAux.sql.Clear;
  FqueryAux.Close;
  FqueryAux.SQL.Add('select                  ');
  FqueryAux.SQL.Add(' ci.NOME                ');
  FqueryAux.SQL.Add(' from                   ');
  FqueryAux.SQL.Add('  cliente cl            ');
  FqueryAux.SQL.Add('  join cidade ci on     ');
  FqueryAux.SQL.Add('    cl.CIDADE = ci.ID   ');
  FqueryAux.SQL.Add('  where                 ');
  FqueryAux.SQL.Add('   ci.id = '+Id+'       ');
  FqueryAux.Open;

  Result := FqueryAux.FieldByName('nome').AsString;
end;

procedure TcadClientes.Persistencia(RegistroNovo: Boolean);
var
  SQL: string;
begin
  FCDS_Aux.Post;
  if RegistroNovo then
  begin
    VerificaEstadoECidade;
    SQL := 'INSERT INTO CLIENTE (NOME, CPF_CNPJ, CEP, ENDERECO, NUMERO, ' +
               'COMPLEMENTO, BAIRRO, CIDADE, DATANASCIMENTO) VALUES (' +
     QuotedStr(FCDS_Aux.FieldByName('NOME_CLIENTE').ASSTRING)+', '+
     QuotedStr(FCDS_Aux.FieldByName('CPF_CNPJ').ASSTRING)+', '+
     QuotedStr(FCDS_Aux.FieldByName('CEP').ASSTRING)+', '+
     QuotedStr(FCDS_Aux.FieldByName('ENDERECO').ASSTRING)+', '+
     QuotedStr(FCDS_Aux.FieldByName('NUMERO').ASSTRING)+', '+
     QuotedStr(FCDS_Aux.FieldByName('COMPLEMENTO').ASSTRING)+', '+
     QuotedStr(FCDS_Aux.FieldByName('BAIRRO').ASSTRING)+', '+
     ObterIDCidade(FCDS_Aux.FieldByName('NOME_CIDADE').ASSTRING)+', '+
     QuotedStr(FormatDateTime('yyyy-mm-dd', FCDS_Aux.FieldByName('DATANASCIMENTO').AsDateTime))+')';
  end
  else
  begin
    SQL :='UPDATE CLIENTE SET '+
     'NOME = ' + QuotedStr(FCDS_Aux.FieldByName('NOME_CLIENTE').ASSTRING)+', '+
     'CEP = ' + QuotedStr(FCDS_Aux.FieldByName('CEP').ASSTRING)+', '+
     'CPF_CNPJ = ' + QuotedStr(FCDS_Aux.FieldByName('CPF_CNPJ').ASSTRING)+', '+
     'ENDERECO = ' + QuotedStr(FCDS_Aux.FieldByName('ENDERECO').ASSTRING)+', '+
     'NUMERO = '+ QuotedStr(FCDS_Aux.FieldByName('NUMERO').ASSTRING)+', '+
     'COMPLEMENTO = '+ QuotedStr(FCDS_Aux.FieldByName('COMPLEMENTO').ASSTRING)+', '+
     'BAIRRO = '+ QuotedStr(FCDS_Aux.FieldByName('BAIRRO').ASSTRING)+', '+
     'CIDADE = '+ QuotedStr(FCDS_Aux.FieldByName('CIDADE').ASSTRING)+', '+
     'DATANASCIMENTO = ' +QuotedStr(FCDS_Aux.FieldByName('DATANASCIMENTO').ASSTRING) +
     ' WHERE ID = '+ IntToStr(FCDS_Aux.FieldByName('ID').AsInteger);
  end;

  if ExecutarSQL(SQL) then
  begin
    MessageDlg('Dados salvos com sucesso!',TMsgDlgType.mtConfirmation,[TMsgDlgBtn.mbOK],0);
  end;
end;

procedure TcadClientes.RetornarDadosDoCliente(IdCliente:integer);
var
  I: Integer;
  Field: TField;
begin
  FCDS_Aux.Close;
  FqueryClientes.DisableControls;
  if IdCliente > 0 then
  begin
    FqueryClientes.Filtered := false;
    FqueryClientes.Filter := 'ID = '+ inttostr(IdCliente);
    FqueryClientes.Filtered := true;
  end;

  // 1. Criar estrutura de campos no ClientDataSet
  FCDS_Aux.FieldDefs.Clear;
  for I := 0 to FqueryClientes.FieldCount - 1 do
  begin
    Field := FqueryClientes.Fields[I];
    FCDS_Aux.FieldDefs.Add(Field.FieldName, Field.DataType, Field.Size);
  end;

  // 2. Criar o dataset
  FCDS_Aux.CreateDataSet;

  // 3. Copiar dados registro por registro
  FqueryClientes.First;
  while not FqueryClientes.Eof do
  begin
    FCDS_Aux.Append;
    for I := 0 to FqueryClientes.FieldCount - 1 do
    begin
      FCDS_Aux.Fields[I].Value := FqueryClientes.Fields[I].Value;
    end;
    FCDS_Aux.Post;
    FqueryClientes.Next;
  end;

  FCDS_Aux.First;
  FDTS_Aux.DataSet := FCDS_Aux;
  FqueryClientes.Filtered := false;
  FqueryClientes.EnableControls;
end;

end.

